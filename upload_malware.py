#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import configparser
import mysql.connector as mariadb
import hashlib
import binascii

config = configparser.ConfigParser()
config.read('config.ini')

mariadb_connection = mariadb.connect(host=config['database']['host'], user=config['database']['user'], password=config['database']['password'], database=config['database']['database'])
cursor = mariadb_connection.cursor()

baseDirectory = '/home/sturla/IJCNN_10000files/'

trainfilesfile = open('/home/sturla/poc/train.txt', 'r')
train = trainfilesfile.read().splitlines()
trainfilesfile.close()

testfilesfile = open('/home/sturla/poc/test.txt', 'r')
test = testfilesfile.read().splitlines()
testfilesfile.close()


# TODO: Er hashene lagret korrekt? Mulig at konverteringen fra string til binary(32) er feil

print("Uploading training files...")
numTraining = len(train)
i = 0
for trainFile in train:
    fullpath = baseDirectory + trainFile
    parts = fullpath.split('/')
    md5 = binascii.unhexlify(parts[-1])
    family = parts[-2]
    filehandle = open(fullpath, 'rb')
    rawfile = filehandle.read()
    sha256 = hashlib.sha256(rawfile).digest()
    cursor.execute('INSERT INTO file(sha256, md5, file, family, training) VALUES (%s, %s, %s, %s, %s)', [sha256, md5, rawfile, family, 1])
    filehandle.close()
    i += 1
    if i % 100 == 0:
        mariadb_connection.commit() # Keep connection alive
        print("Uploaded " + str(i) + " / " + str(numTraining))

mariadb_connection.commit()

print("Uploading testing files...")
numTesting = len(test)
i = 0
for testFile in test:
    fullpath = baseDirectory + testFile
    parts = fullpath.split('/')
    md5 = binascii.unhexlify(parts[-1])
    family = parts[-2]
    filehandle = open(fullpath, 'rb')
    rawfile = filehandle.read()
    sha256 = hashlib.sha256(rawfile).digest()
    cursor.execute('INSERT INTO file(sha256, md5, file, family, training) VALUES (%s, %s, %s, %s, %s)', [sha256, md5, rawfile, family, 0])
    filehandle.close()
    i += 1
    if i % 100 == 0:
        mariadb_connection.commit() # Keep connection alive
        print("Uploaded " + str(i) + " / " + str(numTesting))

mariadb_connection.commit()

#cursor.execute(<query>)
#result = cursor.fetchall()
#mariadb_connection.commit()